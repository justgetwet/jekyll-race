---
layout: post
title: "autorace.py"
---

kk

```python
class ScrapeOddsPark:

    url_oddspark = "https://www.oddspark.com/autorace"
    
    url_race = url_oddspark + "/RaceList.do?"
    url_odds = url_oddspark + "/Odds.do?"
    url_pred = url_oddspark + "/yosou"
    url_result = url_oddspark + "/RaceResult.do?"
    url_kaisai = url_oddspark + "/KaisaiRaceList.do"

    placeCd_d = {'川口': '02', '伊勢崎': '03', '浜松': '04', '飯塚': '05', '山陽': '06'}
    placeEn_d = {'川口': 'kawaguchi', '伊勢崎': 'isesaki', '浜松': 'hamamatsu',\
                    '飯塚': 'iiduka', '山陽': 'sanyo'}

    def get_soup(self, url):

        try: 
            html = urllib.request.urlopen(url)
        except urllib.error.URLError as e:
            print("URLError", e.reason)
            html = "<html></html>"

        soup = BeautifulSoup(html, "lxml")

        return soup

    def get_df(self, soup):

        df = pd.DataFrame()
        if soup.find("table") == None:
            print("a table is not found.")
        else:
            df = pd.io.html.read_html(soup.prettify())

        return df

    def is_num(self, str_num):
        try:
            float(str_num)
        except ValueError:
            return False
        else:
            return True
```



kj

```python
class Race(ScrapeOddsPark):

    def tuple_string_for_copy(self, s):
        # ("20210606", "飯塚") を作成
        tuple_string = ""
        if s[:2] == "20":
            kdate = s.split("(")[0]
            place = s.split()[1]
            date = datetime.strptime(kdate, "%Y年%m月%d日")
            sdate = str(date.year) + str(date.month).rjust(2, "0") + str(date.day).rjust(2, "0")
            tuple_string = "(" + "'" + sdate + "','" + place + "'" + ")"
        return tuple_string


    def today(self):
        soup = self.get_soup(self.url_kaisai)
        atags = soup.find("table").find_all("a")
        links = [a.get("href") for a in atags if a.get("href") != None]
        links.sort()
        pre_link = ""
        new_links = []
        for link in links:
            if pre_link != link:
                new_links.append(link)
            pre_link = link
        days = [link[9:] for link in new_links if link[10:16] == "OneDay"]
        races = []
        for day in days:
            
            url = self.url_oddspark + day
            soup = self.get_soup(url)
            # 年月日 + レース場
            kaisai_day = soup.find("title").text.split("｜")[0]
            # 1Rの発走時間
            time = "??:??"
            start_time = soup.find("span", class_="start-time")
            if start_time:
                time = soup.find("span", class_="start-time").text.replace("発走時間\xa0", "")
            # ("20210606", "飯塚")
            tps4cp = self.tuple_string_for_copy(kaisai_day)
            # 今日のraceに * 
            date_str = re.sub("=|&", " ", day).split()[1]
            date_str_now = datetime.now().strftime("%Y%m%d")
            mark = ""
            if date_str == date_str_now:
                mark = " *"

            kaisai = kaisai_day + " " + time + " " + tps4cp + mark
            races.append(kaisai)
        
        for race in races:
            print(race)


if __name__=='__main__':

    Race().today()
```

output

```shell
2021年6月9日(水) 飯塚 14:07 ('20210609','飯塚')
2021年6月10日(木) 飯塚 14:07 ('20210610','飯塚')
2021年6月11日(金) 浜松 10:03 ('20210611','浜松')
2021年6月11日(金) 飯塚 14:07 ('20210611','飯塚')
2021年6月12日(土) 浜松 10:03 ('20210612','浜松')
2021年6月12日(土) 飯塚 14:06 ('20210612','飯塚')
2021年6月13日(日) 浜松 10:03 ('20210613','浜松') *
2021年6月13日(日) 飯塚 14:06 ('20210613','飯塚') *
```

